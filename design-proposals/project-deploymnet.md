# Design Proposal: Project Deployment with Kubernetes Operator

**Author**: @kfirtoledo

**Begin Design Discussion**: 2023-11-30

**Status:** draft

## Summary/Abstract

This design proposal outlines the deployment process for the ClusterLink project on a Kubernetes (K8s) cluster.  
The proposal specifically addresses deployment within the K8s environment.\
It will rely on a dedicated K8s operator, to make the deployment more user-friendly, simplified and native to K8s users.

## Background

### Motivation and problem space

This design proposal aims to simplify and enhance the deployment of the ClusterLink project.
By leveraging K8s native mechanisms, such as operators and CRDs, the objective is to establish a user-friendly deployment process.\
Currently, ClusterLink deployment involves using the cl-adm CLI, which generates a large YAML file that contains the control plane and dataplane deployments, services, and RBAC configurations.\
In the new design, this process will be managed by the ClusterLink operator, which will consume a simpler and more concise YAML configuration.

### Impact and desired outcome

Implementing this proposal is expected to improve the accessibility and ease of use for ClusterLink users.\
Aligning the deployment process with K8s standards will particularly benefit use cases involving central control management.

### Prior discussion and links

Not applicable.

## User/User Story

The purpose of ClusterLink is to interconnect various clusters within the same fabric.\
These clusters may be managed by different owners, located on different cloud providers, and situated in different locations.\
The deployment of ClusterLink is done by the cluster owner.\
Each cluster owner is required to obtain the Fabric CA certificate and the cluster certificates (private and public keys) from the fabric administrator.

## Goals

This design document should:

* Define the steps for deploying a ClusterLink gateway to a K8s cluster.
* Define the task functions of the ClusterLink operator.
* Define the CRD (Custom Resource Definition) for the ClusterLink operator.

## Non-Goals

The following aspects are explicitly excluded and are out of scope in the current design:

* This document focuses only on the deployment of ClusterLink to the K8s cluster.
The deployment to another environment as VMs is out of scope.
* Security considerations related to the creation of certificates for the fabric or each site by the fabric administrator are also beyond the scope of this document

## Proposal

The ClusterLink deployment will be done in the following steps:

1. Deploy the cluster certificates as k8s secrets to the cluster.
   The certificate include the public Fabric CA certificates and the site certificate that generated by the fabric administrator.
2. Create the ClusterLink operator.
3. Deploy the ClusterLink CRD to the operator ClusterLink deployments that includes:

   * ClusterLink controlplane deployment, including controlplane-pod, controlplane-service, and RBAC roles.  
   * ClusterLink dataplane deployment, including dataplane pods, whether single or multiple, along with the dataplane-service..
   * ClusterLink external access point using load-balancer/node-port/gateway-API service.
  
Overall, the ClusterLink deployment stages are:

<img src="deployment.png" width="800" height="400" alt="ClusterLink Deployment Stages"/>

The operator will be created in a dedicated namespace and, by default, will be ```cl-operator-ns```. It will have privileged permissions, enabling it to create ClusterLink components within the dedicated namespace.
The ClusterLink components will be created in ```clusterlink-system-ns```, and the control-plane will have privileged permissions to execute operations on the ClusterLink CRDs, such as peer, export, import, policy, etc.
Additionally, the operator will create and update components in response to the ```clusterlink.yaml``` create or update actions. Once created or updated, the operator will not actively monitor the state of each component, assuming that any changes will be made only by privileged users.
Furthermore, the operator will delete all components and the namespace of ClusterLink when the ```clusterlink.yaml``` file is deleted.

The deployment file for the operator and example of ```clusterlink.yaml``` will be included in every project release.

The ClusterLink CLI will be utilized to automate the deployment process.\
For instance, the following commands can assist the fabric administrator in creating certificates in the directory ```~/.config/clustrlink/<fabric_name>```:

    clusterlink create fabric --name <fabric_name>
    clusterlink create site --name <site_name> --fabric <fabric_name> 

Automation for deploying the certificates as a secret to the cluster, deploying the ClusterLink operator, and the ```clusterlink.yaml``` can be achieved with

    clusterlink install --site <site_name>

### ClusterLink CRD

The ClusterLink CRD includes the following fields:

* Api version: clusterlink.net/v1alpha1
* Kind: clusterlink

* **Spec Section:**
  
    | Field name | Description | Default value |
    | ---- | ----- | ------ |
    |dataplane.type| Types of dataplane, supported values "go" or "envoy"|"envoy"|
    |dataplane.replicates| Number of dataplane replicas|1|
    |logLevel| Log level severity| "info"|
    |containerRegistry| The container registry to pull the project images. If empty, it will use the local registry| ghcr.io/clusterlink-net|
    |imageTag| The project images version | latest|
    |serviceType| Type of service to expose ClusterLink deployment, supported values: "load-balancer", "API-gateway", "node-port". |load-balancer|

* **Status section:**

    | Field name | Description | Default value |
    | ----------- | ----------- | ------------- |
    | status      | Status of the components controlled by the operator. Supported values: <br> None - if all components have not been created. <br> Ready - if all components are in a ready and running status. <br> Error - If one of the components is in an error status. <br> Update - if one of the components is in an update status. | None |
    | message     | Optional message that provides additional information about the status. | None |

Example to clusterlink CRD:
```
apiVersion: clusterlink.net/v1alpha1
kind: ClusterLink
metadata:
  namespace: clusterlink-ns
  name: peer1
spec:
  dataplane:
    type: "envoy"
    replicates: 1
```


## Impacts / Key Questions

* Do we need the ClusterLink CLI? The only command that seems necessary is for fabric and peer certificates.
* Need to have a security discussion focusing on how and who deploys the peer and fabric certificates.

## Risks and Mitigations

Not applicable.

### Security Considerations

For the deployment of ClusterLink, the Fabric CA certificate (public key) and the peer certificates (public and private keys) must be provided. These certificates will be deployed to the cluster using k8s-secrets and should be handled by the cluster owner. The creation of these certificates can be performed by the central management, which is outside the scope of this document.

The ClusterLink operator will have privileged permissions to deploy the ClusterLink project to the cluster. The control plane of ClusterLink will be granted privileged access to all cluster resources through RBAC (Role-Based Access Control).

In the future, we may introduce a Namespace deployment, which will have permissions limited to a single namespace.

## Future Milestones

In the first step, the k8s operator will be built and will utilize the current cl-adm implementation to create peer and fabric certificates.  
The `cl-adm create peer1` command will also generate the files: k8s-secret.yaml (containing all the certificates for the control-plane and data-plane) and clusterlink.yaml (containing the manifests for the cl-operator).  
The cl-operator will be deployed manually and will use the clusterlink.yaml to deploy the clusterlink components.
The deployment will be a cluster deployment with privileged permissions.

In the second step, the deployment process will be as described in the user section.

## Implementation Details

The k8s operator will be built using the [Kubebuilder](https://kubebuilder.io/) tool, which allows easy building of k8s APIs and operators in Go.

### Testing Plan

Todo

### Update/Rollback Compatibility

Todo
.

### Scalability

Todo

### Implementation Phases/History

Todo
